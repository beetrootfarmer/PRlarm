name: PR Review Reminder

on:
  schedule:
    # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë§¤ ì‹œê°„ ì‹¤í–‰ (ì‹¤ì œ ì‚¬ìš© ì‹œ ì¡°ì • í•„ìš”)
    - cron: "0 5 * * 1-5"
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get pending PRs
        id: pending-prs
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            // ì‚¬ìš©ì ë§¤í•‘ íŒŒì¼ ë¡œë“œ (íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì‚¬ìš©)
             let userMapping = {};
             try {
               if (fs.existsSync('.github/workflows/user-mapping.json')) {
                 const mappingData = fs.readFileSync('.github/workflows/user-mapping.json', 'utf8');
                 userMapping = JSON.parse(mappingData).github_to_slack || {};
               }
             } catch (error) {
               console.log('ì‚¬ìš©ì ë§¤í•‘ íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
             }
             
             // GitHub ì‚¬ìš©ìëª…ì„ Slack IDë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
             function getSlackId(githubUsername) {
               return userMapping[githubUsername] ? `<@${userMapping[githubUsername]}>` : githubUsername;
             }
             
             // ì§€ë¼ í‹°ì¼“ ID ì¶”ì¶œ í•¨ìˆ˜
            function extractJiraTicket(pr) {
               // "Related issue" ì„¹ì…˜ ì°¾ê¸° ì‹œë„
               const relatedIssueRegex = /(?:related|linked|connected)\s+(?:issue|issues|ticket|tickets)[^\n]*\n([\s\S]*?)(?:\n\s*\n|\n*$)/i;
               const relatedSection = pr.body.match(relatedIssueRegex);
               
               let searchText = relatedSection && relatedSection[1] ? relatedSection[1] : pr.body;
               
               // genesisnest.atlassian.net ë„ë©”ì¸ì„ í¬í•¨í•œ ë§í¬ ì°¾ê¸°
               const jiraLinkRegex = /https?:\/\/genesisnest\.atlassian\.net\/browse\/([A-Z]+-\d+)/g;
               const allMatches = [...searchText.matchAll(jiraLinkRegex)];
               
               if (allMatches.length > 0) {
                 // ì²« ë²ˆì§¸ ë§¤ì¹˜ì˜ í‹°ì¼“ ID ë°˜í™˜
                 return allMatches[0][1];
               }
               
               // ë°±ì—…: ë³¸ë¬¸ ì „ì²´ì—ì„œ Jira í‹°ì¼“ ID íŒ¨í„´ ì°¾ê¸°
               const jiraTicketRegex = /([A-Z]+-\d+)/g;
               const matches = pr.body.match(jiraTicketRegex);
               
               return matches[0];
             }

             const prs = await github.rest.pulls.list({
               owner: context.repo.owner,
               repo: context.repo.repo,
               state: 'open'
             });

             let message = "ğŸ“‹ *ë¦¬ë·° ëŒ€ê¸° ì¤‘ì¸ PR ëª©ë¡*\n\n";
             let hasPRs = false;

              for (const pr of prs.data) {
               // ë¦¬ë·° ìƒíƒœ í™•ì¸ (ìŠ¹ì¸ëœ PRì€ ì œì™¸)
               const reviews = await github.rest.pulls.listReviews({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 pull_number: pr.number
               });
               
               

            // ë¦¬ë·°ì–´ë³„ ìµœì‹  ë¦¬ë·° ìƒíƒœ í™•ì¸
            const reviewerStatus = {};
            reviews.data.forEach(review => {
              // ê° ë¦¬ë·°ì–´ì˜ ê°€ì¥ ìµœì‹  ë¦¬ë·° ìƒíƒœë§Œ ì €ì¥
              if (!reviewerStatus[review.user.login] || 
                  new Date(reviewerStatus[review.user.login].submitted_at) < new Date(review.submitted_at)) {
                reviewerStatus[review.user.login] = review;
              }
            });

            // í˜„ì¬ ìš”ì²­ëœ ë¦¬ë·°ì–´ ëª©ë¡
            const currentRequestedReviewers = pr.requested_reviewers.map(r => r.login);

            // ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸ (ëª¨ë“  í˜„ì¬ ìš”ì²­ëœ ë¦¬ë·°ì–´ê°€ ì•„ì§ ìŠ¹ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜, ìŠ¹ì¸ í›„ ìƒˆ ì»¤ë°‹ì´ ìˆëŠ” ê²½ìš°)
            let needsReview = false;

            // í˜„ì¬ ìš”ì²­ëœ ê° ë¦¬ë·°ì–´ì— ëŒ€í•´ í™•ì¸
            for (const reviewer of currentRequestedReviewers) {
              // ë¦¬ë·°ì–´ê°€ ì•„ì§ ë¦¬ë·°í•˜ì§€ ì•Šì•˜ê±°ë‚˜, ìµœì‹  ë¦¬ë·°ê°€ ìŠ¹ì¸ì´ ì•„ë‹Œ ê²½ìš°
              if (!reviewerStatus[reviewer] || reviewerStatus[reviewer].state !== 'APPROVED') {
                needsReview = true;
                break;
              }
              
              // ìŠ¹ì¸í–ˆì§€ë§Œ ê·¸ ì´í›„ì— ìƒˆ ì»¤ë°‹ì´ ì¶”ê°€ëœ ê²½ìš°
              const approvalDate = new Date(reviewerStatus[reviewer].submitted_at);
              const lastCommitDate = new Date(pr.head.sha.committed_date || pr.updated_at);
              
              if (approvalDate < lastCommitDate) {
                needsReview = true;
                break;
              }
            }

            // ë¦¬ë·°ê°€ í•„ìš”í•œ PRë§Œ í¬í•¨
            if (!needsReview) continue;

               if (pr.requested_reviewers && pr.requested_reviewers.length > 0) {
                 hasPRs = true;
                 
                 // ë¦¬ë·°ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Slack IDë¡œ ë³€í™˜)
                 const reviewers = pr.requested_reviewers
                   .map(r => {
                     if (r.login) {
                       return getSlackId(r.login);
                     } else if (r.slug) {
                       return `íŒ€: ${r.slug}`;
                     } else {
                       return 'ì•Œ ìˆ˜ ì—†ëŠ” ë¦¬ë·°ì–´';
                     }
                   })
                   .join(', ');
                 
                 // ì§€ë¼ í‹°ì¼“ ì •ë³´ ì¶”ì¶œ
                  const jiraTicket = extractJiraTicket(pr);
                 let jiraInfo = '';
                 if (jiraTicket) {
                   jiraInfo = ` | ì§€ë¼: <https://genesisnest.atlassian.net/browse/${jiraTicket}|${jiraTicket}>`;
                 }
                 
                 // PR ìƒì„±ì¼ë¡œë¶€í„° ê²½ê³¼ì¼ ê³„ì‚°
                 const createdDate = new Date(pr.created_at);
                 const today = new Date();
                 const daysOld = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));
                 let urgencyEmoji = '';
                 
                if (daysOld >= 3) {
                   urgencyEmoji = 'ğŸ‚'; // 3ì¼ ì´ìƒ ì§€ë‚œ PR
                 } else if (daysOld >= 1) {
                   urgencyEmoji = 'ğŸƒ'; // 1-2ì¼ ì§€ë‚œ PR
                 } else {
                   urgencyEmoji = 'ğŸŒ±'; // ì˜¤ëŠ˜ ìƒì„±ëœ PR
                 }
                 
                 // ë‹´ë‹¹ì ì •ë³´ ì¶”ê°€
                 const assignees = pr.assignees && pr.assignees.length > 0 
                   ? pr.assignees.map(a => getSlackId(a.login)).join(', ')
                   : 'ì—†ìŒ';
                 
                 message += `${urgencyEmoji} <${pr.html_url}|#${pr.number}: ${pr.title}>${jiraInfo}\n`;
                 message += `   â€¢ ë¦¬ë·°ì–´: ${reviewers}\n`;
                 message += `   â€¢ ë‹´ë‹¹ì: ${assignees}\n`;
                 
                 message += `   â€¢ ìš”ì²­ì¼: ${createdDate.toLocaleDateString('ko-KR')} (${daysOld === 0 ? 'ì˜¤ëŠ˜' : `${daysOld}ì¼ ì „`)}\n\n`;
               }
             }
             

             if (!hasPRs) {
               message = "ğŸ™Œ*í˜„ì¬ ë¦¬ë·° ëŒ€ê¸° ì¤‘ì¸ PRì´ ì—†ìŠµë‹ˆë‹¤.* ğŸ‰";
             }

             core.setOutput('message', message);
             core.setOutput('has_prs', hasPRs.toString());

             // ë””ë²„ê¹…ì„ ìœ„í•´ ì½˜ì†”ì— ì¶œë ¥
             console.log(message);

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: "C08JG1LKT44" # ìŠ¬ë™ ì±„ë„ ID
          slack-message: ${{ steps.pending-prs.outputs.message }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
