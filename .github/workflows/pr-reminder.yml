name: PR Review Reminder

on:
  schedule:
    # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë§¤ ì‹œê°„ ì‹¤í–‰ (ì‹¤ì œ ì‚¬ìš© ì‹œ ì¡°ì • í•„ìš”)
    - cron: "0 * * * *"
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get pending PRs
        id: pending-prs
        uses: actions/github-script@v6
        with:
          script: |

            // ì‚¬ìš©ì ë§¤í•‘ íŒŒì¼ ë¡œë“œ (íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì‚¬ìš©)
             let userMapping = {};
             try {
               if (fs.existsSync('.github/user-mapping.json')) {
                 const mappingData = fs.readFileSync('.github/user-mapping.json', 'utf8');
                 userMapping = JSON.parse(mappingData).github_to_slack || {};
               }
             } catch (error) {
               console.log('ì‚¬ìš©ì ë§¤í•‘ íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
             }
             
             // GitHub ì‚¬ìš©ìëª…ì„ Slack IDë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
             function getSlackId(githubUsername) {
               return userMapping[githubUsername] ? `<@${userMapping[githubUsername]}>` : githubUsername;
             }
             
             // ì§€ë¼ í‹°ì¼“ ID ì¶”ì¶œ í•¨ìˆ˜
             function extractJiraTicket(text) {
               const jiraRegex = /([A-Z]+-\d+)/g;
               const matches = text.match(jiraRegex);
               return matches ? matches[0] : null;
             }

             const prs = await github.rest.pulls.list({
               owner: context.repo.owner,
               repo: context.repo.repo,
               state: 'open'
             });

             let message = "ğŸ“‹ *ë¦¬ë·° ëŒ€ê¸° ì¤‘ì¸ PR ëª©ë¡*\n\n";
             let hasPRs = false;

              for (const pr of prs.data) {
               // ë¦¬ë·° ìƒíƒœ í™•ì¸ (ìŠ¹ì¸ëœ PRì€ ì œì™¸)
               const reviews = await github.rest.pulls.listReviews({
                 owner: context.repo.owner,
                 repo: context.repo.repo,
                 pull_number: pr.number
               });
               
               // ìµœì‹  ë¦¬ë·°ê°€ ìŠ¹ì¸ì¸ì§€ í™•ì¸
               const isApproved = reviews.data.some(review => 
                 review.state === 'APPROVED' && 
                 !reviews.data.some(r => 
                   r.submitted_at > review.submitted_at && 
                   r.state !== 'APPROVED'
                 )
               );
               
               // ìŠ¹ì¸ëœ PRì€ ê±´ë„ˆë›°ê¸°
               if (isApproved) continue;
               
               if (pr.requested_reviewers && pr.requested_reviewers.length > 0) {
                 hasPRs = true;
                 
                 // ë¦¬ë·°ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Slack IDë¡œ ë³€í™˜)
                 const reviewers = pr.requested_reviewers
                   .map(r => {
                     if (r.login) {
                       return getSlackId(r.login);
                     } else if (r.slug) {
                       return `íŒ€: ${r.slug}`;
                     } else {
                       return 'ì•Œ ìˆ˜ ì—†ëŠ” ë¦¬ë·°ì–´';
                     }
                   })
                   .join(', ');
                 
                 // ì§€ë¼ í‹°ì¼“ ì •ë³´ ì¶”ì¶œ
                 const jiraTicket = extractJiraTicket(pr.title);
                 let jiraInfo = '';
                 if (jiraTicket) {
                   jiraInfo = ` | ì§€ë¼: ${jiraTicket}`;
                 }
                 
                 // PR ìƒì„±ì¼ë¡œë¶€í„° ê²½ê³¼ì¼ ê³„ì‚°
                 const createdDate = new Date(pr.created_at);
                 const today = new Date();
                 const daysOld = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));
                 let urgencyEmoji = '';
                 
                 if (daysOld >= 5) {
                   urgencyEmoji = 'ğŸ”´'; // 5ì¼ ì´ìƒ ì§€ë‚œ PR
                 } else if (daysOld >= 3) {
                   urgencyEmoji = 'ğŸŸ '; // 3-4ì¼ ì§€ë‚œ PR
                 } else if (daysOld >= 1) {
                   urgencyEmoji = 'ğŸŸ¡'; // 1-2ì¼ ì§€ë‚œ PR
                 } else {
                   urgencyEmoji = 'ğŸŸ¢'; // ì˜¤ëŠ˜ ìƒì„±ëœ PR
                 }
                 
                 // ë‹´ë‹¹ì ì •ë³´ ì¶”ê°€
                 const assignees = pr.assignees && pr.assignees.length > 0 
                   ? pr.assignees.map(a => getSlackId(a.login)).join(', ')
                   : 'ì—†ìŒ';
                 
                 message += `${urgencyEmoji} <${pr.html_url}|#${pr.number}: ${pr.title}>${jiraInfo}\n`;
                 message += `   â€¢ ë¦¬ë·°ì–´: ${reviewers}\n`;
                 message += `   â€¢ ë‹´ë‹¹ì: ${assignees}\n`;
                 message += `   â€¢ ìƒì„±ì¼: ${createdDate.toLocaleDateString()} (${daysOld}ì¼ ì „)\n\n`;
               }
             }
             

             if (!hasPRs) {
               message = "í˜„ì¬ ë¦¬ë·° ëŒ€ê¸° ì¤‘ì¸ PRì´ ì—†ìŠµë‹ˆë‹¤.ğŸ™Œ";
             }

             core.setOutput('message', message);
             core.setOutput('has_prs', hasPRs.toString());

             // ë””ë²„ê¹…ì„ ìœ„í•´ ì½˜ì†”ì— ì¶œë ¥
             console.log(message);

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: "C08JG1LKT44" # ìŠ¬ë™ ì±„ë„ ID
          slack-message: ${{ steps.pending-prs.outputs.message }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
